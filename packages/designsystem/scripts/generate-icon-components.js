import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';
import { optimize } from 'svgo';

const warning = `This file is auto-generated by ${path.basename(import.meta.filename)}. Do not edit it manually.`;

const args = (function () {
  const inputArgIndex = process.argv.indexOf('--input');

  if (inputArgIndex === -1 || !process.argv[inputArgIndex + 1]) {
    throw new Error('No input folder specified. Please provide a path to the input folder using the "--input" flag.');
  }
  const inputFolder = process.argv[inputArgIndex + 1];

  const outputArgIndex = process.argv.indexOf('--output');

  if (outputArgIndex === -1 || !process.argv[outputArgIndex + 1]) {
    throw new Error('No output folder specified. Please provide a path to the output folder using the "--output" flag.');
  }
  const outputFolder = process.argv[outputArgIndex + 1];

  const cleanFlagIndex = process.argv.indexOf('--clean-output-folder');

  return {
    inputFolder,
    outputFolder,
    cleanOutputFolder: cleanFlagIndex !== -1,
  };
})();

const optimizeSvg = svgString => {
  const result = optimize(svgString, {
    multipass: true,
    plugins: [
      {
        name: 'preset-default',
        params: {
          overrides: {
            removeViewBox: false,
          },
        },
      },
      {
        name: 'removeAttributesBySelector',
        params: {
          selector: '*',
          attributes: ['width', 'height', 'fill'],
        },
      },
      {
        name: 'addAttributesToSVGElement',
        params: {
          attributes: [
            {
              width: 'WIDTH_PLACEHOLDER',
              height: 'HEIGHT_PLACEHOLDER',
              fill: 'FILL_PLACEHOLDER',
            },
          ],
        },
      },
    ],
  });

  return result.data;
};

const toPascalCase = value => {
  return value.replace(/([-_][a-z0-9])/g, group => group.toUpperCase().replace('-', '').replace('_', '')).replace(/^[a-z0-9]/, firstCharacter => firstCharacter.toUpperCase());
};

const generateWebComponentCode = (componentClassName, webComponentName, svg) => {
  return `/* ${warning} */
import { Component, Host, Prop, h } from '@stencil/core';

   @Component({
   tag: '${webComponentName}',
   styleUrl: './${webComponentName}.css',
   shadow: true,
   })
export class ${componentClassName} {
  @Prop() color = 'var(--crai-icon-color, currentColor)';
  @Prop() size: number | string = '1.2rem';

  private get _size() {
    return typeof this.size === 'number' ? \`\${this.size}px\` : this.size;
  }

  render() {
    return (
        <Host>
            ${svg}
        </Host>
    );
  }
}
`;
};

const generateWebComponentCss = () => {
  return `/* ${warning} */
  :host {
    line-height: 1rem;
    display: flex;
    aspect-ratio: 1 / 1;
    align-items: center;
    justify-content: center;
  }
    `;
};
const main = () => {
  const { inputFolder, outputFolder, cleanOutputFolder } = args;

  if (cleanOutputFolder && fs.existsSync(outputFolder)) {
    console.log(`Cleaning output folder: ${outputFolder}`);
    fs.rmSync(outputFolder, { recursive: true, force: true });
  }

  if (!fs.existsSync(outputFolder)) {
    console.log(`Creating output folder: ${outputFolder}`);
    fs.mkdirSync(outputFolder, { recursive: true });
  }

  const svgFiles = fs.readdirSync(inputFolder).filter(file => file.endsWith('.svg'));

  if (svgFiles.length === 0) {
    console.log(`No SVG files found in ${inputFolder}.`);
    return;
  }

  console.log(`Found ${svgFiles.length} SVG files. Generating components...`);

  for (const svgFile of svgFiles) {
    try {
      const svgFilePath = path.join(inputFolder, svgFile);
      const svgContent = fs.readFileSync(svgFilePath, 'utf-8');
      let optimizedSvg = optimizeSvg(svgContent);

      optimizedSvg = optimizedSvg.replace('width="WIDTH_PLACEHOLDER"', 'width={this._size}');
      optimizedSvg = optimizedSvg.replace('height="HEIGHT_PLACEHOLDER"', 'height={this._size}');
      optimizedSvg = optimizedSvg.replace('fill="FILL_PLACEHOLDER"', 'fill={this.color}');

      const webComponentName = `crai-icon-${path.basename(svgFile, '.svg')}`;
      const componentClassName = toPascalCase(webComponentName);

      const componentCode = generateWebComponentCode(componentClassName, webComponentName, optimizedSvg);
      const cssCode = generateWebComponentCss();

      const componentFolderPath = path.join(outputFolder, webComponentName);

      if (!fs.existsSync(componentFolderPath)) {
        fs.mkdirSync(componentFolderPath);
      }

      const componentFilePath = path.join(componentFolderPath, `${webComponentName}.tsx`);
      fs.writeFileSync(componentFilePath, componentCode);

      const cssFilePath = path.join(componentFolderPath, `${webComponentName}.css`);
      fs.writeFileSync(cssFilePath, cssCode);

      console.log(`Successfully generated ${webComponentName}`);
    } catch (error) {
      console.error(`Error processing ${svgFile}:`, error);
    }
  }

  console.log('Icon component generation complete.');
};

const currentFilePath = fileURLToPath(import.meta.url);
const scriptPath = process.argv[1];

if (currentFilePath === scriptPath) {
  main();
}
